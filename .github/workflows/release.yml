
name: Java CI with Gradle

on:
  create:
    tags:
    - 'v[0-9]+.[0-9]+.[0-9]+*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        path: logstash-input-grpc

    - name: Checkout Logstash
      uses: actions/checkout@v2
      with:
        path: logstash
        repository: elastic/logstash
        ref: 7.17

    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: 11
        distribution: temurin

    - name: Build logstash-core
      uses: gradle/gradle-build-action@937999e9cc2425eddc7fd62d1053baf041147db7
      with:
        gradle-version: current
        build-root-directory: logstash
        arguments: assemble
    
    - name: Build gem
      uses: gradle/gradle-build-action@937999e9cc2425eddc7fd62d1053baf041147db7
      with:
        gradle-version: current
        build-root-directory: logstash-input-grpc
        arguments: gem -PLOGSTASH_CORE_PATH=${{ github.workspace }}/logstash/logstash-core

    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        prerelease: true
        files: |
          logstash-input-grpc/logstash-input-grpc-*.gem